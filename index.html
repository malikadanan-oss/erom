<!-- index.html (Frontend statik untuk GitHub Pages) -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>eROM@AG — Tempahan Bilik • PPD Alor Gajah</title>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    /* Ringkas: gaya asal anda dipadatkan sedikit */
    :root{--bg:#f6f8fb;--text:#111827;--muted:#6b7280;--primary:#2563eb;--ok:#16a34a;--warn:#f59e0b;--bad:#dc2626;--off:#9ca3af;--card:#fff;--ring:#e5e7eb}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:'Oswald',Arial,sans-serif}
    .wrap{max-width:1150px;margin:18px auto;padding:12px}
    h1{font-size:1.5rem;margin:.25rem 0 .75rem}
    .tabs{display:flex;gap:8px;border-bottom:1px solid var(--ring);margin-bottom:10px;flex-wrap:wrap}
    .tabbtn{border:1px solid var(--ring);border-bottom:none;background:#f8fafc;color:#111827;padding:10px 14px;border-top-left-radius:12px;border-top-right-radius:12px;cursor:pointer}
    .tabbtn.active{background:#fff;border-color:var(--ring);font-weight:600}
    .tabpane{display:none}.tabpane.active{display:block}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:12px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    select,input[type="time"],input[type="text"],input[type="date"],button{font-family:inherit;font-size:1rem;border:1px solid var(--ring);border-radius:10px;padding:8px 10px;background:#fff;outline:none}
    select:focus,input:focus{box-shadow:0 0 0 3px rgba(37,99,235,.15)}
    .btn{border:none;background:var(--primary);color:#fff;padding:10px 16px;border-radius:12px;cursor:pointer;transition:.2s}
    .btn.secondary{background:#111827}.btn.ghost{background:#fff;border:1px solid var(--ring);color:#111827}
    .legend{display:flex;gap:12px;align-items:center;margin:8px 0 4px;flex-wrap:wrap}
    .dot{width:14px;height:14px;border-radius:4px;display:inline-block;border:1px solid #0001}
    .dot.green{background:var(--ok)} .dot.orange{background:var(--warn)} .dot.red{background:var(--bad)} .dot.disabled{background:var(--off)}
    .calendar{display:grid;grid-template-rows:auto 1fr;gap:8px}
    .weekday{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;font-size:.9rem;color:var(--muted)} .weekday div{text-align:center}
    .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .tile{background:var(--card);border:1px solid var(--ring);border-radius:12px;min-height:118px;position:relative;overflow:hidden;display:flex;flex-direction:column}
    .tile.disabled{background:#f3f4f6;color:#9ca3af;pointer-events:none}
    .tile .date{font-size:1rem;font-weight:600;padding:8px 10px;display:flex;align-items:center;gap:8px}
    .badge{display:inline-block;border-radius:999px;padding:3px 8px;font-size:.75rem;line-height:1;color:#fff}
    .badge.red{background:var(--bad)} .badge.orange{background:var(--warn)} .badge.green{background:var(--ok)}
    .counts{margin-left:auto;font-size:.75rem;color:#374151;background:#eef2f7;border:1px solid var(--ring);border-radius:999px;padding:2px 8px}
    .tile .body{padding:0 10px 10px;font-size:.95rem;line-height:1.2}
    .listRooms{max-height:96px;overflow-y:auto;padding-bottom:2px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.78rem;border:1px solid var(--ring);margin:2px 4px 2px 0}
    .pill.red{background:rgba(220,38,38,.10);border-color:rgba(220,38,38,.25);color:#991b1b}
    .pill.orange{background:rgba(245,158,11,.10);border-color:rgba(245,158,11,.25);color:#92400e}
    .grid .blank{visibility:hidden}
    .sel{outline:3px solid rgba(37,99,235,.35)}
    .tile.range{outline:3px solid rgba(37,99,235,.35)}
    .small{font-size:.85rem;color:#6b7280}
    .toolbar{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center}
    .monthnav{display:flex;gap:8px;align-items:center}
    .switch{display:inline-flex;background:#eef2f7;border:1px solid var(--ring);border-radius:10px;overflow:hidden}
    .switch button{padding:6px 12px;border:none;background:transparent;cursor:pointer}
    .switch button.active{background:#fff}
    .counter{font-size:.9rem;color:#111827;background:#f1f5f9;border:1px solid var(--ring);padding:6px 10px;border-radius:10px;display:inline-block}
    table{width:100%;border-collapse:collapse;border:1px solid var(--ring)} th,td{padding:8px;border-bottom:1px solid var(--ring);text-align:left;font-size:.95rem}
    th{background:#f8fafc}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.78rem;border:1px solid var(--ring);background:#f1f5f9}
    .tag.red{background:rgba(220,38,38,.10);border-color:rgba(220,38,38,.25);color:#991b1b}
    .tag.orange{background:rgba(245,158,11,.10);border-color:rgba(245,158,11,.25);color:#92400e}
    .req::after{content:" *"; color:#dc2626}
    .invalid{box-shadow:0 0 0 3px rgba(220,38,38,.18) !important; border-color:#dc2626 !important}
    #ovSummaryWrap{margin-top:12px;border-top:1px dashed var(--ring);padding-top:10px}
    #ovSummaryWrap h4{margin:0 0 6px 0;font-size:1rem}
    #ovSummaryList{columns:3; column-gap:20px}
    @media (max-width:900px){ #ovSummaryList{columns:1} }
    @media (max-width:960px){ .toolbar{grid-template-columns:1fr 1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>eROM@AG — Sistem Pengurusan Tempahan Bilik PPD Alor Gajah</h1>

    <div class="tabs">
      <button id="tabTempahanBtn" class="tabbtn active">Tempahan</button>
      <button id="tabKalendarBtn" class="tabbtn">Rumusan Tempahan</button>
      <button id="tabAdminBtn" class="tabbtn">Pentadbir</button>
    </div>

    <!-- Tab: Tempahan -->
    <section id="tabTempahan" class="tabpane active">
      <div class="card toolbar">
        <div>
          <label class="small req">Pilih Bilik</label><br>
          <select id="roomSelect" required><option value="">Sila Pilih Bilik</option></select>
        </div>
        <div class="monthnav" style="justify-self:end">
          <button class="btn ghost" id="btnPrev">&lt; Bulan Sebelum</button>
          <div class="small" id="monthLabel" style="min-width:160px;text-align:center;font-weight:600;color:#111827"></div>
          <button class="btn ghost" id="btnNext">Bulan Seterusnya &gt;</button>
        </div>
        <div style="text-align:right">
          <button class="btn secondary" id="btnRefresh">Segar Semula</button>
        </div>
      </div>

      <div class="card">
        <div class="legend">
          <span class="dot green"></span><span class="small">Tiada tempahan</span>
          <span class="dot orange"></span><span class="small">Separa Penuh</span>
          <span class="dot red"></span><span class="small">Penuh</span>
          <span class="dot disabled"></span><span class="small">Hujung Minggu / Tarikh Lampau</span>
        </div>

        <div class="calendar">
          <div class="weekday"><div>Isn</div><div>Sel</div><div>Rab</div><div>Kha</div><div>Jum</div><div>Sab</div><div>Aha</div></div>
          <div class="grid" id="grid"></div>
        </div>

        <div class="small" id="noRoomHint" style="display:none;margin-top:6px">
          Sila pilih bilik untuk melihat kalendar tempahan.
        </div>
      </div>

      <div class="card" style="margin-top:10px">
        <div class="row" style="justify-content:space-between">
          <div class="switch" title="Tempahan berturut">
            <button id="toggleRangeOff" class="active" type="button">1 Hari</button>
            <button id="toggleRangeOn" type="button">Berturut</button>
          </div>
          <div id="rangeCounter" class="counter" style="display:none">Akan ditempah: 0 hari bekerja</div>
        </div>

        <div class="row" style="margin-top:10px; gap:10px; flex-wrap:wrap">
          <div>
            <label class="small req">Tarikh Dipilih</label><br>
            <input id="pickedDate" type="date" required>
          </div>
          <div id="fromDateWrap" style="display:none">
            <label class="small req">Tarikh Dari</label><br>
            <input id="fromDate" type="date">
          </div>
          <div id="toDateWrap" style="display:none">
            <label class="small req">Tarikh Hingga</label><br>
            <input id="toDate" type="date">
          </div>

          <div>
            <label class="small req">Masa Mula (≥ 08:00)</label><br>
            <input id="startTime" type="time" min="08:00" max="17:00" step="1800" required>
          </div>
          <div>
            <label class="small req">Masa Tamat (≤ 17:00)</label><br>
            <input id="endTime" type="time" min="08:00" max="17:00" step="1800" required>
          </div>
          <div>
            <label class="small req">Kategori</label><br>
            <select id="category" required></select>
          </div>

          <div style="min-width:320px;flex:1">
            <label class="small req">Tujuan / Ringkasan</label><br>
            <input id="note" type="text" placeholder="Contoh: Taklimat SPI Bil." required minlength="3" maxlength="200" oninput="this.value=this.value.trimStart()">
          </div>

          <div>
            <label class="small req">Sektor</label><br>
            <select id="sektor" required></select>
          </div>
          <div>
            <label class="small req">Nama Penempah</label><br>
            <select id="nama" required disabled><option value="">— Sila pilih sektor dahulu —</option></select>
          </div>

          <div style="align-self:end"><button class="btn" id="btnBook">Rekod Tempahan</button></div>
        </div>

        <div class="small" style="margin-top:8px">
          Waktu operasi: Isnin–Jumaat, 08:00–17:00. Tempahan hujung minggu & tarikh lampau tidak dibenarkan.
        </div>
      </div>
    </section>

    <!-- Tab: Rumusan -->
    <section id="tabKalendar" class="tabpane">
      <div class="card toolbar">
        <div class="small" style="font-weight:600">Rumusan Semua Bilik (Read-only)</div>
        <div class="monthnav" style="justify-self:end">
          <button class="btn ghost" id="ovPrev">&lt; Bulan Sebelum</button>
          <div class="small" id="ovMonthLabel" style="min-width:160px;text-align:center;font-weight:600;color:#111827"></div>
          <button class="btn ghost" id="ovNext">Bulan Seterusnya &gt;</button>
        </div>
        <div class="switch">
          <button id="btnViewCalendar" class="active" type="button">Kalendar</button>
          <button id="btnViewTable" type="button">Jadual</button>
        </div>
      </div>

      <div class="card">
        <div class="legend">
          <span class="dot red"></span><span class="small">Merah = Penuh</span>
          <span class="dot orange"></span><span class="small">Jingga = Separa Penuh</span>
          <span class="small" style="margin-left:auto">Bilik tanpa tempahan tidak dipaparkan</span>
        </div>

        <div id="ovCalendarWrap">
          <div class="calendar">
            <div class="weekday"><div>Isn</div><div>Sel</div><div>Rab</div><div>Kha</div><div>Jum</div><div>Sab</div><div>Aha</div></div>
            <div class="grid" id="ovGrid"></div>
          </div>
          <div id="ovSummaryWrap" style="display:none">
            <h4>Rumusan Bulan Ini</h4>
            <div id="ovSummaryList" class="small"></div>
          </div>
        </div>

        <div id="ovTableWrap" style="display:none">
          <table>
            <thead><tr><th style="width:140px">Tarikh</th><th>Bilik</th><th style="width:160px">Status</th></tr></thead>
            <tbody id="ovTableBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Tab: Pentadbir -->
    <section id="tabAdmin" class="tabpane">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div style="font-weight:600">Panel Pentadbir</div>
          <div class="small" id="adminWho"></div>
        </div>

        <div class="row" style="margin-top:8px; gap:12px">
          <div>
            <label class="small">Pilih Bilik (Admin)</label><br>
            <select id="adminRoom"><option value="">Sila Pilih Bilik</option></select>
          </div>
          <div style="align-self:end; display:flex; gap:8px">
            <button class="btn ghost" id="btnAdminLogin">Log Masuk</button>
            <button class="btn ghost" id="btnAdminLoad" disabled>Muat Senarai</button>
            <button class="btn" id="btnBulkCancel" style="display:none;background:#dc2626" disabled>Batalkan Terpilih</button>
          </div>
        </div>

        <div id="adminList" style="margin-top:10px"></div>
      </div>
    </section>
  </div>

<script>
(function(){
  // ====== KONFIGURASI API ======
  const API_BASE = 'https://script.google.com/macros/s/AKfycbwnDjQu7YIzMKVK1gh1G2mJffxfhxsKBVQZB9ESngZ5xzX3ZubQLYAiw-odJC3KmebM/exec'; // contoh: https://script.google.com/macros/s/AKfycb.../exec

  // Panggilan GET tanpa preflight
  async function apiGet(action, params={}) {
    const q = new URLSearchParams({ action, ...params });
    const url = `${API_BASE}?${q.toString()}`;
    const res = await fetch(url, { method: 'GET' });
    return res.ok ? res.json() : null;
  }
  // Panggilan POST tanpa header khas (elak preflight): body JSON + Content-Type default oleh fetch
  async function apiPost(action, bodyObj={}) {
    const res = await fetch(API_BASE, {
      method: 'POST',
      body: JSON.stringify({ action, ...bodyObj })
    });
    return res.ok ? res.json() : null;
  }

  const $ = (id) => document.getElementById(id);

  /* ===== Data Statik: Nama mengikut Sektor (boleh ubah ikut keperluan) ===== */
  const NAMA_MENGIKUT_SEKTOR = {
    "Pengurusan Tertinggi": ["Tuan Haji Ab Malek Bin Kasim (B.K.T)","En. Azhar Bin Md Nor (B.C.M)","En. Abd Jabar Bin Md Yusup (P.J.K)","En. Muhammad Hamka Bin Dollah","En. Bashir Bin Abu Bakar"],
    "School Improvement Partner (SIP+)": ["En. Amran Bin Abdul Sukor","En. Abd. Razak Bin Adam","Pn. Rafidah Binti Abd Rahim"],
    "Sektor Perancangan": ["En. Saifullah Bin Abdul Wahab","En. Hairoldin Rahim Bin Taya"],
    "Sektor Pembelajaran": ["En. Hairuljaki Bin Omar","Pn. Zuraini Binti Bakri","Ustazah Pauziah Binti Othman","En. Razman Bin Mohammad","En. Mohd Anis Bin Abdul Majid","Pn. Norasiah Binti Ahmad","Pn. Wan Norhayati Binti Wan Ibrahim","Pn. Sabiah Binti Ninggal","Pn. Puteri Hanizah Binti Megat Amaddin","Pn. Khairul Bariah Binti Ismail","Pn. Rohana Binti Jantan","En. Fakrul Izhar Bin Ramlee","Ustaz Mahadi Bin Suboh","Ustaz Kamarul Zaman Bin Sahat","En. Mohd Shahril Amri B. Mohamed Shahar","En. Mohd Eirwan Bin Halim","Pn. Mariyam Binti Ahmad","En. Wan Norarif Bin Wan Muhammad","Pn. Nor Jamilahton Holija'ah Bt Ariffin","En. Munzir Bin Md Rosnan","En. Mohd Rizal Bin Maslah","Pn. Faezah Binti Ali","En. Mohd Izwan Bin Othman","En. Mohd Kamarul Hafiz Bin Abdul Rashid","En. Malik Abdullah Bin Adanan","Pn. Mas Azahwati Binti Ab Aziz"],
    "Sektor Pengurusan Sekolah": ["Pn. Addelennoor Binti Abu","Pn. Siti Noorus Sa'adah Binti Md Ramli","En. Muhammad Hafiz Bin Hamdan","En. Mazli Bin Malek","En. Kadin Bin Abu @ Sim Ah Tong","En. Nor Afandi Bin Safar","En. Adnan Bin Isenin","Pn. Kavitha A/P Kannan","Pn. Irmadila Binti Mat Ismail","Pn. Masayu Binti Kari"],
    "Sektor Pembangunan Murid": ["En. Wan Mohd Syarifuddin Bin Wan Hasan","En. Ismail Asib Bin Md Amin","En. Mohammad Misbahuddin Bin Abu Mansor"],
    "Sektor Pentaksiran & Peperiksaan": ["En. Mohd Rahdi Bin Ahmad","En. Zaidi Bin Jaafar"],
    "Psikologi & Kaunseling": ["En. Mohd Saberi Bin Minhat @ Bulat"],
    "Sektor Pengurusan": ["Pn. Asmalaili Binti Ahmad Sanusi","Pn. Fahizah Binti Mohd Yusoff","Cik Nurul Jannah Binti Mohd Nasir","Pn. Nor Fizana Binti Md Idris","Pn. Nurul Ain Binti Mohd Zaini","Pn. Intan Liyana Binti Khamis","Pn. Habsah Binti Maidin","En. Md Zaki Zabani Bin Mohd Nor","Pn. Faizzah Binti Zulkefli","En. Mustafa Bin Musa","En. Rozamni Bin Muhamad","Pn. Katijah Binti Mohd Ali","En. Zasmeini Bin Zaimun","Pn. Suzanawati Binti Mohd Said","Pn. Kamsiah Binti Hashim","Pn. Hartiniwatie Binti Abang","En. Azharul Nizam Bin Othmawi","Pn. Rosedah Binti Muhamad","Pn. Noor 'Izzati Binti Johari","En. Mohd Arifin Bin Kamarudin","Pn. Siti Rajunah Binti Ab. Rahman","Pn. Fairus Binti Zainal","Pn. Hanizah Binti Minhat","Cik Siti Aishah Binti Md Hassan","Cik Nurain Nabihah Binti Nasaruddin","En. Mohd Fauzi Bin Mohamed Ali","En. Muhammad Nasiruddin Bin Muei","En. Muhammad Fadhli Mustaqim Bin Mazlan","En. Muhammad Afiq Bin Yang Rosdi","Pn. Haslina Binti Beeran Kutty"]
  };

  // ====== STATE ======
  let state = { isAdmin:false, year:null, month:null, room:'', days:[], selectedDate:null, range:{from:null,to:null}, rangeMode:false };
  let ov = { year:null, month:null, days:[], view:'calendar' };
  let ALL_ROOMS = [];
  let ADMIN_PASSWORD = localStorage.getItem('erom_admin_pw') || '';

  window.addEventListener('load', bootstrap);

  async function bootstrap(){
    const now = new Date();
    state.year = now.getFullYear(); state.month = now.getMonth()+1;
    ov.year = now.getFullYear(); ov.month = now.getMonth()+1;

    setupUI();
    // init data asas
    const boot = await apiGet('init');
    if (!boot || !boot.ok) { return Swal.fire('Ralat', 'Gagal memuat data asas aplikasi.', 'error'); }
    ALL_ROOMS = boot.rooms || [];
    hydrateSelect($('roomSelect'), ['Sila Pilih Bilik', ...ALL_ROOMS], true);
    hydrateSelect($('adminRoom'), ['Sila Pilih Bilik', ...ALL_ROOMS], true);
    hydrateSelect($('category'), boot.categories || []);
    hydrateSelect($('sektor'), ['— Pilih Sektor —', ...(boot.sektor||[])], true);

    // cuba sahkan admin jika kata laluan telah disimpan
    if (ADMIN_PASSWORD) {
      const chk = await apiGet('adminCheck', { adminPassword: ADMIN_PASSWORD });
      state.isAdmin = !!(chk && chk.ok && chk.isAdmin);
      updateAdminUI();
    }

    populateNamaOptions();
    toggleCalendarHint();
    await loadOverview();
  }

  // ====== UI & EVENT ======
  function setupUI(){
    $('monthLabel').textContent = formatMonthLabel(state.year, state.month);
    $('ovMonthLabel').textContent = formatMonthLabel(ov.year, ov.month);

    $('tabTempahanBtn').addEventListener('click', ()=> switchTab('tempahan'));
    $('tabKalendarBtn').addEventListener('click', ()=> switchTab('kalendar'));
    $('tabAdminBtn').addEventListener('click', ()=> switchTab('admin'));

    $('roomSelect').addEventListener('change', onRoomSelectChange);
    $('btnRefresh').addEventListener('click', resetUI);
    $('btnBook').addEventListener('click', onBook);
    $('pickedDate').addEventListener('change', onPickedDateChange);
    $('toggleRangeOff').addEventListener('click', ()=>setRangeMode(false));
    $('toggleRangeOn').addEventListener('click', ()=>setRangeMode(true));
    $('fromDate').addEventListener('change', onRangeChange);
    $('toDate').addEventListener('change', onRangeChange);
    $('grid').addEventListener('click', onGridClick);
    $('sektor').addEventListener('change', populateNamaOptions);

    // navigator bulan
    setupMonthNavigator({ stateObj: state, prevBtn:'btnPrev', nextBtn:'btnNext', label:'monthLabel', onShift: ()=>{ if(state.room) refreshMonth(); } });
    setupMonthNavigator({ stateObj: ov, prevBtn:'ovPrev', nextBtn:'ovNext', label:'ovMonthLabel', onShift: loadOverview });

    // overview view switch
    $('btnViewCalendar').addEventListener('click', ()=>switchOverviewView('calendar'));
    $('btnViewTable').addEventListener('click', ()=>switchOverviewView('table'));

    // admin login + actions
    $('btnAdminLogin').addEventListener('click', onAdminLogin);
    $('btnAdminLoad').addEventListener('click', loadAdminUpcoming);
    $('btnBulkCancel').addEventListener('click', onBulkCancel);
  }

  function updateAdminUI(){
    $('btnAdminLoad').disabled = !state.isAdmin;
    $('btnBulkCancel').disabled = !state.isAdmin;
    $('adminWho').textContent = state.isAdmin ? 'Akses: Pentadbir' : 'Belum log masuk';
  }

  async function onAdminLogin(){
    const { value: pw } = await Swal.fire({
      title: 'Kata laluan pentadbir',
      input: 'password',
      inputPlaceholder: 'Masukkan kata laluan',
      inputAttributes: { autocapitalize:'off', autocorrect:'off' },
      confirmButtonText: 'Sahkan',
      showCancelButton: true
    });
    if (!pw) return;
    const chk = await apiGet('adminCheck', { adminPassword: pw });
    if (chk && chk.ok && chk.isAdmin) {
      ADMIN_PASSWORD = pw;
      localStorage.setItem('erom_admin_pw', pw);
      state.isAdmin = true;
      updateAdminUI();
      Swal.fire('Berjaya', 'Akses pentadbir diaktifkan.', 'success');
    } else {
      Swal.fire('Ralat', 'Kata laluan salah.', 'error');
    }
  }

  function switchTab(name){
    const map={tempahan:{btn:'tabTempahanBtn',pane:'tabTempahan'},kalendar:{btn:'tabKalendarBtn',pane:'tabKalendar'},admin:{btn:'tabAdminBtn',pane:'tabAdmin'}};
    Object.keys(map).forEach(k=>{ const {btn,pane}=map[k]; $(btn).classList.toggle('active',k===name); $(pane).classList.toggle('active',k===name); });
    if(name==='admin' && state.isAdmin && $('adminRoom').value){ loadAdminUpcoming(); }
    if(name==='kalendar' && (!ov.days || !ov.days.length)){ loadOverview(); }
  }

  function setupMonthNavigator({ stateObj, prevBtn, nextBtn, label, onShift }) {
    $(prevBtn).addEventListener('click', () => shiftMonth(-1));
    $(nextBtn).addEventListener('click', () => shiftMonth(1));
    function shiftMonth(delta) {
      let y = stateObj.year, m = stateObj.month + delta;
      if (m < 1) { m = 12; y--; }
      if (m > 12) { m = 1; y++; }
      stateObj.year = y; stateObj.month = m;
      $(label).textContent = formatMonthLabel(y, m);
      onShift();
    }
  }

  function formatMonthLabel(y,m){ const name=new Intl.DateTimeFormat('ms-MY',{month:'long'}).format(new Date(y,m-1,1)); return `${name} ${y}`; }
  function markInvalid(el){ el.classList.add('invalid'); setTimeout(()=>el.classList.remove('invalid'), 1200); el.focus(); }

  function hydrateSelect(sel, items, includeFirstAsPlaceholder=false){
    sel.innerHTML=''; items.forEach((v,i)=> sel.appendChild(new Option(v, includeFirstAsPlaceholder && i===0 ? '' : v)));
  }
  function populateNamaOptions(){
    const sekVal=$('sektor').value, namaSel=$('nama'); namaSel.innerHTML='';
    if(!sekVal || !NAMA_MENGIKUT_SEKTOR[sekVal]){ namaSel.appendChild(new Option('— Sila pilih sektor dahulu —','')); namaSel.disabled=true; return; }
    namaSel.disabled=false; namaSel.appendChild(new Option('— Pilih nama —','')); NAMA_MENGIKUT_SEKTOR[sekVal].forEach(n=> namaSel.appendChild(new Option(n,n)));
  }
  function toggleCalendarHint(){ $('noRoomHint').style.display = state.room ? 'none' : 'block'; }

  function onRoomSelectChange() {
    state.room = $('roomSelect').value;
    resetBookingForm(false);
    toggleCalendarHint();
    if(state.room) { refreshMonth(); } else { $('grid').innerHTML=''; }
  }
  function resetUI(){
    const now=new Date(); state.year=now.getFullYear(); state.month=now.getMonth()+1; $('monthLabel').textContent=formatMonthLabel(state.year,state.month);
    state.days=[]; $('grid').innerHTML=''; document.querySelectorAll('.tile.sel').forEach(el=>el.classList.remove('sel'));
    $('roomSelect').value=''; state.room=''; toggleCalendarHint();
    resetBookingForm(true);
    if(state.isAdmin){ $('adminRoom').value=''; $('adminList').innerHTML=''; $('btnBulkCancel').style.display='none'; }
    switchTab('tempahan'); window.scrollTo({top:0,behavior:'smooth'});
  }
  function resetBookingForm(clearFields){
    setRangeMode(false);
    $('pickedDate').required=true; $('fromDate').required=false; $('toDate').required=false;
    $('rangeCounter').style.display='none'; $('rangeCounter').textContent='';
    if (clearFields){
      ['pickedDate', 'fromDate', 'toDate', 'startTime', 'endTime', 'note'].forEach(id => $(id).value = '');
      const sek=$('sektor'); if(sek && sek.options.length) sek.selectedIndex=0;
      populateNamaOptions();
    }
    state.selectedDate=null; state.range={from:null,to:null};
  }
  function setRangeMode(on){
    state.rangeMode = !!on;
    $('toggleRangeOff').classList.toggle('active', !on);
    $('toggleRangeOn').classList.toggle('active', on);
    $('pickedDate').closest('div').style.display = on ? 'none' : 'block';
    $('fromDateWrap').style.display = on ? 'block' : 'none';
    $('toDateWrap').style.display = on ? 'block' : 'none';
    $('rangeCounter').style.display = on ? 'inline-block' : 'none';
    state.selectedDate=null; $('pickedDate').value='';
    state.range={from:null,to:null}; $('fromDate').value=''; $('toDate').value='';
    document.querySelectorAll('#grid .tile.sel').forEach(el=>el.classList.remove('sel'));
    highlightRangeTiles(); updateRangeCounter();
  }

  // ====== KALENDAR BILIK ======
  async function refreshMonth(){
    if(!state.room){ toggleCalendarHint(); return; }
    Swal.fire({title:'Memuat data kalendar...',allowOutsideClick:false,didOpen:()=>Swal.showLoading()});
    const res = await apiGet('getMonthView', { room: state.room, year: state.year, month: state.month });
    Swal.close();
    if(!res||!res.ok){ return Swal.fire('Ralat', res?.error || 'Gagal memuat data kalendar', 'error'); }
    state.days=res.days||[];
    renderCalendar(); highlightSelectedTile(); highlightRangeTiles(); updateRangeCounter();
  }
  function renderCalendar(){
    const grid=$('grid'); grid.innerHTML='';
    if(state.days.length===0) return;
    const docFrag=document.createDocumentFragment();
    const first=state.days[0]; const weekday=first.weekday===0?7:first.weekday;
    for(let i=0;i<weekday-1;i++){ const x=document.createElement('div'); x.className='blank'; docFrag.appendChild(x); }
    for(const dayData of state.days){ docFrag.appendChild(buildTile(dayData)); }
    grid.appendChild(docFrag);
  }
  function buildTile(day){
    const isWeekend = (day.weekday === 0 || day.weekday === 6);
    const tile=document.createElement('div');
    tile.className=`tile ${(day.isPast||isWeekend)?'disabled':''}`;
    tile.dataset.date=day.date;
    const top=document.createElement('div'); top.className='date'; top.textContent=Number(day.date.slice(8,10));
    if (!day.isPast && !isWeekend) {
      const statusMap = {red:'Penuh', orange:'Separa Penuh', green:'Tiada tempahan'};
      const badge=document.createElement('span'); badge.className=`badge ${day.status}`; badge.textContent = statusMap[day.status] || '';
      top.appendChild(badge);
    }
    tile.appendChild(top);
    const body=document.createElement('div'); body.className='body';
    if(!day.isPast && !isWeekend){
      const list=document.createElement('div'); list.className='small';
      if(day.bookings && day.bookings.length > 0){
        (day.bookings||[]).forEach(b=>{
          const p=document.createElement('div');
          const note=b.note?` • ${truncate(b.note,30)}`:''; p.textContent=`${b.start}–${b.end} • ${b.category}${note}`; list.appendChild(p);
        });
      } else {
        const p=document.createElement('div'); p.className='small'; p.textContent='Tiada tempahan.'; list.appendChild(p);
      }
      body.appendChild(list);
    }
    tile.appendChild(body);
    return tile;
  }
  function onGridClick(ev){
    const tile = ev.target.closest('.tile');
    if(!tile || tile.classList.contains('disabled')) return;
    if(state.rangeMode){
      const clickedDate = tile.dataset.date;
      if(!state.range.from){ state.range.from = clickedDate; }
      else if(!state.range.to){
        if(clickedDate < state.range.from){ state.range.to = state.range.from; state.range.from = clickedDate; }
        else { state.range.to = clickedDate; }
      } else { state.range = {from: clickedDate, to: null}; }
      $('fromDate').value = state.range.from || '';
      $('toDate').value = state.range.to || '';
      highlightRangeTiles(); updateRangeCounter(); onRangeChange();
    } else {
      document.querySelectorAll('#grid .tile.sel').forEach(el=>el.classList.remove('sel'));
      tile.classList.add('sel');
      state.selectedDate=tile.dataset.date;
      $('pickedDate').value=state.selectedDate;
    }
  }
  function onPickedDateChange(){
    state.selectedDate = $('pickedDate').value || null;
    if (!state.selectedDate) { highlightSelectedTile(); return; }
    const day = state.days.find(x=>x.date===state.selectedDate);
    if(day && day.status==='red'){
      Swal.fire('Makluman', 'Tarikh ini penuh. Sila pilih tarikh lain.', 'info');
      $('pickedDate').value=''; state.selectedDate=null;
    }
    highlightSelectedTile();
  }
  function highlightSelectedTile(){
    document.querySelectorAll('#grid .tile.sel').forEach(el=>el.classList.remove('sel'));
    if(!state.selectedDate) return;
    const el=document.querySelector(`#grid .tile[data-date="${state.selectedDate}"]`); if(el) el.classList.add('sel');
  }
  function highlightRangeTiles(){
    document.querySelectorAll('#grid .tile.range').forEach(el=>el.classList.remove('range'));
    if(!state.range.from || !state.range.to) return;
    let d = state.range.from;
    while (d <= state.range.to){
      const el=document.querySelector(`#grid .tile[data-date="${d}"]`); if(el) el.classList.add('range');
      d = addDaysYMD(d, 1);
    }
  }
  function onRangeChange(){
    state.range.from=$('fromDate').value||null; state.range.to=$('toDate').value||null;
    if(state.range.from && state.range.to && state.range.from > state.range.to){
      Swal.fire('Peringatan','Tarikh Dari mestilah sebelum atau sama dengan Tarikh Hingga.','warning');
    }
    highlightRangeTiles(); updateRangeCounter();
  }
  function updateRangeCounter(){ if(!state.rangeMode){ $('rangeCounter').textContent=''; return;} const n=countWorkingDaysInRange(state.range.from,state.range.to); $('rangeCounter').textContent=`Akan ditempah: ${n} hari bekerja`; }

  // ====== TEMPAHAN ======
  async function onBook(){
    const inputs = {
      room: $('roomSelect').value, start: $('startTime').value, end: $('endTime').value,
      category: $('category').value, note: $('note').value.trim(), nama: $('nama').value.trim(), sektor: $('sektor').value
    };
    if(!inputs.room){ markInvalid($('roomSelect')); return Swal.fire('Peringatan','Sila pilih bilik.','warning'); }
    if(!inputs.start){ markInvalid($('startTime')); return Swal.fire('Peringatan','Sila pilih masa mula.','warning'); }
    if(!inputs.end){ markInvalid($('endTime')); return Swal.fire('Peringatan','Sila pilih masa tamat.','warning'); }
    if(!inputs.category){ markInvalid($('category')); return Swal.fire('Peringatan','Sila pilih kategori.','warning'); }
    if(!inputs.note){ markInvalid($('note')); return Swal.fire('Peringatan','Sila isi Tujuan / Ringkasan.','warning'); }
    if(!inputs.sektor){ markInvalid($('sektor')); return Swal.fire('Peringatan','Sila pilih sektor.','warning'); }
    if(!inputs.nama){ markInvalid($('nama')); return Swal.fire('Peringatan','Sila pilih nama penempah.','warning'); }

    $('btnBook').disabled = true;
    Swal.fire({title:'Merekod tempahan...',allowOutsideClick:false,didOpen:()=>Swal.showLoading()});
    try {
      let res;
      if (state.rangeMode) {
        inputs.startDate = $('fromDate').value;
        inputs.endDate = $('toDate').value;
        if (!inputs.startDate) { markInvalid($('fromDate')); throw new Error('Sila isi "Tarikh Dari".'); }
        if (!inputs.endDate) { markInvalid($('toDate')); throw new Error('Sila isi "Tarikh Hingga".'); }
        res = await apiPost('createBookingRange', inputs);
        if (!res || !res.ok) throw new Error(res?.error || 'Gagal merekod tempahan julat.');
        await Swal.fire({ icon:'success', title:`Disimpan: ${res.savedCount||0} hari.`, timer:1500, position:'top', showConfirmButton:false });
      } else {
        inputs.date = $('pickedDate').value;
        if (!inputs.date) { markInvalid($('pickedDate')); throw new Error('Sila pilih "Tarikh Dipilih".'); }
        res = await apiPost('createBooking', inputs);
        if (!res || !res.ok) throw new Error(res?.error || 'Gagal merekod tempahan.');
        await Swal.fire({ icon:'success', title:'Tempahan disimpan!', timer:1500, position:'top', showConfirmButton:false });
      }
      if(state.room) await refreshMonth();
      await loadOverview();
    } catch(err){
      await Swal.fire('Ralat', err?.message || 'Proses tempahan gagal.', 'error');
    } finally {
      $('btnBook').disabled = false;
    }
  }

  // ====== OVERVIEW ======
  async function loadOverview(){
    Swal.fire({title:'Memuat rumusan bulanan...',allowOutsideClick:false,didOpen:()=>Swal.showLoading()});
    const res = await apiGet('getMonthRoomsOverview', { year: ov.year, month: ov.month });
    Swal.close();
    if(!res || !res.ok){ return Swal.fire('Ralat', res?.error || 'Gagal memuat rumusan', 'error'); }
    ov.days = Array.isArray(res.days) ? res.days : [];
    renderOverview();
  }
  function switchOverviewView(view){
    ov.view = (view === 'table') ? 'table' : 'calendar';
    $('btnViewCalendar').classList.toggle('active', ov.view==='calendar');
    $('btnViewTable').classList.toggle('active', ov.view==='table');
    $('ovCalendarWrap').style.display = ov.view==='calendar' ? 'block' : 'none';
    $('ovTableWrap').style.display = ov.view==='table' ? 'block' : 'none';
    renderOverview();
  }
  function renderOverview(){
    if (ov.view === 'calendar') { renderOvCalendar(); renderOvSummary(); }
    else { renderOvTable(); }
  }
  function renderOvCalendar(){
    const grid = $('ovGrid'); grid.innerHTML='';
    const lastDayOfMonth = new Date(ov.year, ov.month, 0).getDate();
    const firstDow = (new Date(ov.year, ov.month - 1, 1).getDay() + 6) % 7; // 0=Isnin
    for(let i=0;i<firstDow;i++){ const x=document.createElement('div'); x.className='blank'; grid.appendChild(x); }
    const dayMap = new Map((ov.days||[]).map(d => [d.date, d]));
    for(let d=1; d<=lastDayOfMonth; d++){
      const ymd = `${ov.year}-${String(ov.month).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const dayData = dayMap.get(ymd);
      const tile = document.createElement('div'); tile.className = 'tile';
      const top = document.createElement('div'); top.className='date'; top.textContent = d;
      if (dayData && (dayData.counts?.red || dayData.counts?.orange)) {
        const cnt = document.createElement('span'); cnt.className='counts';
        cnt.textContent = `Penuh:${dayData.counts.red||0} | Separa:${dayData.counts.orange||0}`;
        top.appendChild(cnt);
      }
      tile.appendChild(top);
      const body = document.createElement('div'); body.className='body';
      if (dayData?.rooms?.length){
        const list = document.createElement('div'); list.className='listRooms';
        dayData.rooms.forEach(it=>{
          const pill = document.createElement('span');
          pill.className = `pill ${it.status}`;
          pill.textContent = it.room;
          list.appendChild(pill);
        });
        body.appendChild(list);
      }
      tile.appendChild(body);
      grid.appendChild(tile);
    }
  }
  function renderOvSummary(){
    const list = $('ovSummaryList'); list.innerHTML='';
    if(!ALL_ROOMS.length){ $('ovSummaryWrap').style.display='none'; return; }
    const counter = new Map();
    (ov.days||[]).forEach(d=> (d.rooms||[]).forEach(r=> counter.set(r.room, (counter.get(r.room)||0) + 1)));
    const rows = ALL_ROOMS.map(room => [room, counter.get(room)||0]).sort((a,b)=> (b[1]-a[1]) || a[0].localeCompare(a[0],'ms'));
    list.innerHTML = rows.map(([room,c])=> `• ${room} (${c} tempahan)`).join('<br>');
    $('ovSummaryWrap').style.display='block';
  }
  function renderOvTable(){
    const tbody = $('ovTableBody'); tbody.innerHTML='';
    const rows = [];
    (ov.days||[]).forEach(d=>{ (d.rooms||[]).forEach(r=> rows.push({date:d.date, room:r.room, status:r.status})); });
    rows.sort((a,b)=> a.date.localeCompare(b.date) || (a.status === 'red' ? -1 : 1) || a.room.localeCompare(b.room, 'ms'));
    const frag=document.createDocumentFragment();
    rows.forEach(x=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${x.date}</td><td>${x.room}</td><td><span class="tag ${x.status==='red'?'red':'orange'}">${x.status==='red'?'Penuh':'Separa Penuh'}</span></td>`;
      frag.appendChild(tr);
    });
    tbody.appendChild(frag);
  }

  // ====== ADMIN ======
  async function loadAdminUpcoming(){
    const room = $('adminRoom').value;
    if(!room){ $('adminList').innerHTML='<div class="small">Sila pilih bilik untuk memuatkan senarai tempahan akan datang.</div>'; $('btnBulkCancel').style.display='none'; return; }
    if(!state.isAdmin){ return Swal.fire('Akses ditolak','Sila log masuk pentadbir dahulu.','warning'); }
    $('adminList').innerHTML='<div class="small">Memuatkan data...</div>';
    const res = await apiGet('listUpcomingBookings', { room, adminPassword: ADMIN_PASSWORD });
    if(!res || !res.ok){ $('adminList').innerHTML='<div class="small" style="color:#dc2626">Gagal memuatkan data.</div>'; return; }
    const items = res.items || [];
    if(!items.length){ $('adminList').innerHTML='<div class="small">Tiada tempahan akan datang untuk bilik ini.</div>'; $('btnBulkCancel').style.display='none'; return; }
    const html = ['<table><thead><tr><th style="width:34px"><input type="checkbox" onchange="toggleAllCheckboxes(this.checked)"></th><th style="width:120px">Tarikh</th><th style="width:120px">Masa</th><th>Bilik</th><th style="width:160px">Kategori</th><th>Tujuan</th><th style="width:160px">Penempah</th></tr></thead><tbody>'];
    for(const it of items){
      html.push(`<tr>
        <td><input type="checkbox" class="chkCancel" data-id="${it.id}"></td>
        <td>${it.date}</td>
        <td>${(it.start||'')+'–'+(it.end||'')}</td>
        <td>${it.room||''}</td>
        <td>${it.category||''}</td>
        <td>${escapeHtml(it.note||'')}</td>
        <td>${escapeHtml(it.nama||'')}<div class="small">${it.sektor||''}</div></td>
      </tr>`);
    }
    html.push('</tbody></table>');
    $('adminList').innerHTML = html.join('');
    $('btnBulkCancel').style.display='inline-block';
  }

  window.toggleAllCheckboxes = (checked) => {
    document.querySelectorAll('.chkCancel').forEach(cb => cb.checked = checked);
  };

  async function onBulkCancel(){
    const checks=[...document.querySelectorAll('.chkCancel:checked')];
    if(!checks.length) return Swal.fire('Makluman','Tiada tempahan dipilih untuk dibatalkan.','info');
    const ids = checks.map(x=>x.dataset.id);
    const { value: reason } = await Swal.fire({ title: 'Sebab Pembatalan?', input: 'text', inputPlaceholder:'Contoh: Pembetulan jadual atau pertindihan acara', showCancelButton: true, inputValidator: (v) => !v && 'Sebab pembatalan wajib diisi.' });
    if (!reason) return;
    const res = await apiPost('batalTempahanBulk', { ids, reason, adminPassword: ADMIN_PASSWORD });
    if(!res || !res.ok) return Swal.fire('Ralat', res?.error || 'Gagal melaksanakan pembatalan.', 'error');
    await Swal.fire('Selesai', `Berjaya dibatalkan: ${res.updated} tempahan.`, 'success');
    await loadAdminUpcoming();
    if(state.room) await refreshMonth();
    await loadOverview();
  }

  // ====== UTILITI ======
  function truncate(s, n){ return s?.length>n ? s.slice(0,n-1)+'…' : s; }
  function escapeHtml(str) { return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }
  function toYMDLocal(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
  function parseYMDToLocal(ymd){ const [y,m,d]=ymd.split('-').map(Number); return new Date(y, m-1, d); }
  function addDaysYMD(ymd, n){ const dt=parseYMDToLocal(ymd); dt.setDate(dt.getDate()+n); return toYMDLocal(dt); }
  function weekdayOfYMD(ymd){ return parseYMDToLocal(ymd).getDay(); }
  function countWorkingDaysInRange(from,to){
    if(!from||!to) return 0; let d = from, n = 0;
    while (d <= to){
      const tile=document.querySelector(`.tile[data-date="${d}"]`);
      if(tile && !tile.classList.contains('disabled')) n++;
      d = addDaysYMD(d, 1);
    }
    return n;
  }
})();
</script>
</body>
</html>
